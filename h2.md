```python
import pandas as pd
import matplotlib.pyplot as plt
import networkx as nx

# 任務資料
tasks = [
    (1,"研擬計畫",1, []),
    (2,"任務分配",4, [1]),
    (3,"取得硬體",17,[1]),
    (4,"程式開發",70,[2]),
    (5,"安裝硬體",10,[3]),
    (6,"程式測試",30,[4]),
    (7,"撰寫手冊",25,[5]),
    (8,"轉換檔案",20,[5]),
    (9,"系統測試",25,[6]),
    (10,"使用者訓練",20,[7,8]),
    (11,"使用者測試",25,[9,10]),
]

df = pd.DataFrame(tasks, columns=["id","name","dur","pred"])
df = df.set_index("id")

# 建立圖
G = nx.DiGraph()
for tid, row in df.iterrows():
    G.add_node(tid, dur=row["dur"], name=row["name"])
    for p in row["pred"]:
        G.add_edge(p, tid)

# Forward pass (ES, EF)
ES, EF = {}, {}
for tid in nx.topological_sort(G):
    if not list(G.predecessors(tid)):
        ES[tid] = 0
    else:
        ES[tid] = max(EF[p] for p in G.predecessors(tid))
    EF[tid] = ES[tid] + df.loc[tid,"dur"]

# Backward pass (LS, LF)
project_finish = max(EF.values())
LS, LF = {}, {}
for tid in reversed(list(nx.topological_sort(G))):
    if not list(G.successors(tid)):
        LF[tid] = project_finish
    else:
        LF[tid] = min(LS[s] for s in G.successors(tid))
    LS[tid] = LF[tid] - df.loc[tid,"dur"]

# Slack 與關鍵路徑
slack = {tid: LS[tid]-ES[tid] for tid in df.index}
critical = [tid for tid in df.index if slack[tid]==0]

print("專案總工期:", project_finish, "天")
print("關鍵路徑:", " → ".join(map(str, critical)))

# --- 繪製 PERT/CPM 圖 ---
pos = nx.spring_layout(G, seed=1)
plt.figure(figsize=(10,6))
nx.draw(G, pos, with_labels=True, node_size=2000, node_color="lightblue")
labels = {tid: f"{tid}\n{df.loc[tid,'name']}\n{df.loc[tid,'dur']}天" for tid in G.nodes()}
nx.draw_networkx_labels(G, pos, labels)
plt.title("PERT/CPM 圖")
plt.show()

# --- 繪製甘特圖 ---
plt.figure(figsize=(10,6))
for i, tid in enumerate(df.index):
    plt.barh(i, df.loc[tid,"dur"], left=ES[tid], color="red" if tid in critical else "skyblue")
    plt.text(ES[tid]+df.loc[tid,"dur"]/2, i, f"{tid}", va="center", ha="center", color="white")
plt.yticks(range(len(df.index)), [f"{tid}:{df.loc[tid,'name']}" for tid in df.index])
plt.xlabel("天數")
plt.title("甘特圖")
plt.gca().invert_yaxis()
plt.show()
